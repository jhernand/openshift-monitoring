#
# Copyright (c) 2018 Red Hat, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

---

# This rule starts an AWX (a.k.a. Ansible Tower) job.

apiVersion: monitoring.openshift.io/v1alpha1
kind: HealingRule
metadata:
  name: run-awx-job
spec:
  conditions:
  - alert: "NodeDown"
  actions:
  - delimiters:
      left: "[["
      right: "]]"
    awxJob:
      address: https://tower.private/api
      secretRef:
        name: awx
      project: "Healing actions"
      template: "Ensure oVirt host"
      extraVars: |-
        {
          "ovirt_host": "[[ $labels.instance ]]"
        }

---

# This rule starts a batch job that uses Python to say hello.

apiVersion: monitoring.openshift.io/v1alpha1
kind: HealingRule
metadata:
  name: run-batch-job
spec:
  conditions:
  - alert: "RunBatchJob"
  actions:
  - batchJob:
      apiVersion: batch/v1
      kind: Job
      metadata:
        name: hello
      spec:
        template:
          spec:
            containers:
            - name: python
              image: python
              command:
              - python
              - -c
              - print("Hello!")
            restartPolicy: Never

---

# This rule runs an Ansible playbook.

apiVersion: monitoring.openshift.io/v1alpha1
kind: HealingRule
metadata:
  name: run-playbook
spec:
  conditions:
  - alert: "RunPlaybook"
  actions:
  - delimiters:
      left: "[["
      right: "]]"
    ansiblePlaybook:
      playbook: |-
        ---
        - name: Ensure oVirt host
          hosts: localhost
          connection: local
          gather_facts: false
          pre_tasks:
          - name: Login to oVirt
            ovirt_auth:
              url: https://engine42.example.com/ovirt-engine/api
              username: admin@internal
              password: redhat123
              insecure: true
          tasks:
          - name: "Ensure host [[ $labels.instance ]]"
            ovirt_vms:
              name: "jhernand-openshift-{{ [[ $labels.instance ]] | regexp_replace('\\..*$', '') }}"
              state: running
          post_tasks:
          - name: Logout from oVirt
            ovirt_auth:
              state: absent
              ovirt_auth: "{{ ovirt_auth }}"
      inventory: |-
        localhost
