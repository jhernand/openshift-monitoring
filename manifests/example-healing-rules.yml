#
# Copyright (c) 2018 Red Hat, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

---

# This rule starts an AWX (a.k.a. Ansible Tower) job.

apiVersion: monitoring.openshift.io/v1alpha1
kind: HealingRule
metadata:
  name: node-down
spec:
  conditions:
  - alert: "node-down-.*"
  actions:
  - awxJob:
      address: https://tower.private/api
      secretRef:
        name: awx
      project: "Healing actions"
      template: "Ensure nodes"

---

# This rule starts a batch job that uses Python to say hello.

apiVersion: monitoring.openshift.io/v1alpha1
kind: HealingRule
metadata:
  name: welcome
spec:
  conditions:
  - alert: "hello-.*"
  actions:
  - batchJob:
      apiVersion: batch/v1
      kind: Job
      metadata:
        name: hello
      spec:
        template:
          spec:
            containers:
            - name: python
              image: python
              command:
              - python
              - -c
              - print("Hello!")
            restartPolicy: Never

---

# This rule runs an Ansible playbook.

apiVersion: monitoring.openshift.io/v1alpha1
kind: HealingRule
metadata:
  name: playbook
spec:
  conditions:
  - alert: "playbook-.*"
  actions:
  - ansiblePlaybook:
      playbook: |-
        ---
        - name: Ensure nodes
          hosts: localhost
          connection: local
          gather_facts: false
          pre_tasks:
          - name: Login to oVirt
            ovirt_auth:
              url: "{{ ovirt_url }}"
              username: "{{ ovirt_user }}"
              password: "{{ ovirt_password }}"
              insecure: true
          tasks:
          - name: Ensure master
            ovirt_vms:
              name: jhernand-openshift-master
              state: running
          - name: Ensure node0
            ovirt_vms:
              name: jhernand-openshift-node0
              state: running
          - name: Ensure node1
            ovirt_vms:
              name: jhernand-openshift-node1
              state: running
          post_tasks:
          - name: Logout from oVirt
            ovirt_auth:
              state: absent
              ovirt_auth: "{{ ovirt_auth }}"
      inventory: |-
        localhost
      extraVars: |-
        {
          "ovirt_url": "https://engine42.local/ovirt-engine",
          "ovirt_user": "admin@internal",
          "ovirt_password": "redhat123"
        }
